SELECT
    -- 1. Geographic Identifier
    tpu.Zone AS pickup_zone,
    
    -- 2. Temporal Identifier (Day Only)
    CASE EXTRACT(DAYOFWEEK FROM t.tpep_pickup_datetime)
        WHEN 1 THEN 'Sunday'
        WHEN 2 THEN 'Monday'
        WHEN 3 THEN 'Tuesday'
        WHEN 4 THEN 'Wednesday'
        WHEN 5 THEN 'Thursday'
        WHEN 6 THEN 'Friday'
        WHEN 7 THEN 'Saturday'
    END AS day_name,
    
    -- 3. Volume Metrics
    COUNT(1) AS total_trips_in_segment,
    
    -- *** CRITICAL ADDITION 1: AVERAGE DURATION for ROI CALCULATION ***
    AVG(t.trip_duration_minutes) AS average_trip_duration_minutes, 
    
    -- 4. Efficiency Metrics
    APPROX_QUANTILES(t.calculated_total_amount / t.trip_duration_minutes, 2)[OFFSET(1)] AS median_rpm_usd_per_min,
    
    -- 5. *** CRITICAL ADDITION 2: CRISIS COUNT for Strategic Ordering ***
    SUM(
        CASE 
            -- Counts how many trips in the segment are below the critical $1.50 RPM threshold
            WHEN (t.calculated_total_amount / t.trip_duration_minutes) < 1.50 
            THEN 1 
            ELSE 0 
        END
    ) AS crisis_trip_count
    
FROM
    `nyc-taxi-478617.2024_data.yellow_trips_2024_cleaned` AS t
JOIN
    `nyc-taxi-478617.2024_data.taxi_zone_lookup` AS tpu
    ON t.PULocationID = tpu.LocationID
    
WHERE
    t.trip_duration_minutes > 1.0 
    AND t.calculated_total_amount > 2.0 

GROUP BY 1, 2
    
HAVING
    COUNT(1) >= 100000 
    
ORDER BY 
    -- ** CRITICAL CHANGE: Order by the highest number of crisis trips **
    crisis_trip_count DESC,
    median_rpm_usd_per_min ASC 
LIMIT 10;
